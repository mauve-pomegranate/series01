<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Into the Æther: Story Bible</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .prose-custom {
            font-family: 'Lora', serif;
        }
        .prose-custom h1, .prose-custom h2, .prose-custom h3, .prose-custom h4, .prose-custom h5 {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.3s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .editable[contenteditable="true"]:focus {
            outline: 2px solid #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        /* Link Styles */
        .prose-custom a.internal-link { color: #6d28d9; text-decoration: none; font-weight: 600; cursor: pointer; }
        .prose-custom a.internal-link:hover { text-decoration: underline; }
        .prose-custom a.external-link { color: #059669; text-decoration: none; font-weight: 600; }
        .prose-custom a.external-link:hover { text-decoration: underline; }
        .prose-custom a.external-link::after { content: ' ↗'; display: inline-block; font-size: 0.8em; vertical-align: super; }
        
        /* Search Highlight */
        .highlight { background-color: #fef08a; border-radius: 0.25rem; padding: 0 2px; }
        .search-highlight { background-color: #fcd34d; animation: flash 1.5s ease-in-out; }
        @keyframes flash { 0% { background-color: #fcd34d; } 50% { background-color: #fef08a; } 100% { background-color: #fcd34d; } }

        /* Edit Mode UI */
        #mode-toggle-group, #export-button { display: none; }
        body.full-access #mode-toggle-group { display: flex; }
        body.edit-mode.full-access #export-button { display: block; }
        
        .add-entry-btn, .add-link-btn { display: none; }
        body.edit-mode .add-entry-btn, body.edit-mode .add-link-btn { display: block; }
        
        body.edit-mode .prose-custom a { pointer-events: none; }
        
        /* Login Animation */
        #password-overlay.dissolving { opacity: 0; transition: opacity 1.5s ease-out; }
        #password-overlay.dissolving::after {
            content: ''; position: absolute; inset: 0;
            background: conic-gradient(from 90deg at 50% 50%, #6366f1, #a855f7, #ec4899, #f59e0b, #84cc16, #10b981, #06b6d4, #3b82f6, #6366f1);
            filter: blur(80px) saturate(2); opacity: 1; transition: opacity 1s ease-out; z-index: 1;
        }
        #password-overlay.dissolving > div { transition: opacity 0.5s ease-in; opacity: 0; }

        /* Navigation Accordion Styles */
        #navigation-container summary {
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
        }
        #navigation-container summary:hover {
            background-color: #e5e7eb;
        }
        #navigation-container summary::-webkit-details-marker {
            display: none;
        }
        #navigation-container summary::before {
            content: '►';
            margin-right: 0.5rem;
            font-size: 0.6em;
            transition: transform 0.2s;
        }
        #navigation-container details[open] > summary::before {
            transform: rotate(90deg);
        }
        #navigation-container details .nav-links {
            padding-left: 1.5rem;
            border-left: 1px solid #d1d5db;
            margin-left: 0.5rem;
        }
        /* Table Styles */
        .prose-custom table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .prose-custom th, .prose-custom td {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            text-align: left;
        }
        .prose-custom th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="password-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Enter Access Code</h2>
            <p class="text-gray-600 mb-6">This story bible is protected.</p>
            <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Password">
            <button id="submit-password" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-colors">Unlock</button>
            <p id="password-error" class="text-red-500 mt-4 text-sm hidden">Incorrect password. Please try again.</p>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-30">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"/>
                        </svg>
                        <h1 class="text-xl font-bold text-gray-800 ml-2">Into the Æther: Story Bible</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="mode-toggle-group" class="flex items-center p-1 bg-gray-200 rounded-full full-access-only">
                            <button id="view-mode-btn" class="px-3 py-1 text-sm font-medium rounded-full transition-colors">View</button>
                            <button id="edit-mode-btn" class="px-3 py-1 text-sm font-medium rounded-full transition-colors">Edit</button>
                        </div>
                        <div class="relative w-64">
                            <input type="search" id="search-input" class="w-full pl-10 pr-4 py-2 border rounded-full text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Search bible...">
                            <div class="absolute top-0 left-0 mt-2 ml-3">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <div id="search-results-container" class="absolute mt-1 w-full bg-white rounded-md shadow-lg z-20 hidden max-h-80 overflow-y-auto"></div>
                        </div>
                        <button id="export-button" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition edit-mode-only full-access-only">Export for GitHub</button>
                        <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-600 transition">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="lg:grid lg:grid-cols-12 lg:gap-8">
                <nav class="lg:col-span-3 mb-8 lg:mb-0">
                    <div id="navigation-container" class="sticky top-24">
                        </div>
                </nav>

                <main id="content-area" class="lg:col-span-9">
                    </main>
            </div>
        </div>
    </div>

    <div id="add-link-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Add a Link</h3>
            <div>
                <label for="link-text" class="block text-sm font-medium text-gray-700">Link Text</label>
                <input type="text" id="link-text" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
            <div class="mt-4">
                <label for="link-type" class="block text-sm font-medium text-gray-700">Link Type</label>
                <select id="link-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="internal">Internal Cross-Reference</option>
                    <option value="external">External Link (e.g., Wikipedia)</option>
                </select>
            </div>
            <div class="mt-4">
                <label for="link-target" class="block text-sm font-medium text-gray-700" id="link-target-label">Reference (Entry Name)</label>
                <input type="text" id="link-target" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Alex 'Bowie' Shepard">
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-link-button" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</button>
                <button id="insert-link-button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Insert Link</button>
            </div>
        </div>
    </div>
    
    <div id="export-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-2">Export Full HTML for GitHub</h3>
            <p class="text-sm text-gray-600 mb-4">Copy the entire text below and paste it into your `index.html` file on GitHub to save all changes permanently.</p>
            <textarea id="export-textarea" class="w-full h-64 p-2 border border-gray-300 rounded-md font-mono text-xs"></textarea>
            <div class="mt-4 flex justify-end space-x-3">
                 <button id="copy-export-button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Copy to Clipboard</button>
                <button id="close-export-button" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Close</button>
            </div>
        </div>
    </div>

    <script id="app-logic">
    // --- DATA STORE ---
    let storyBibleData = {};

    // --- APPLICATION LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        // Build the story bible data object now that all data files are loaded
        storyBibleData = {
            "Series Overview": {
                "Series Overview": [
                    {
                        "title": "Series Logline",
                        "content": "<p>Across fractured realities and hidden worlds, a diverse group of individuals—an American expatriate, a half-kitsune investigator, a hardened operative, and resilient survivors of a broken America—must unravel ancient prophecies, confront corporate conspiracies, and battle cosmic entities to prevent the annihilation of all existence, forcing them to question the nature of identity, sacrifice, and the threads that bind family and fate.</p>"
                    },
                    {
                        "title": "Working Titles (By Book)",
                        "content": "<ul><li>Book 1: Fate and Foxfire</li><li>Book 2: Family and Folklore</li><li>Book 3: Faith and Finality</li></ul>"
                    },
                    {
                        "title": "Genre & Audience",
                        "content": "<p><strong>Primary Genre:</strong> Urban Fantasy / Speculative Fiction</p><p><strong>Secondary Elements:</strong> Conspiracy Thriller, Post-Apocalyptic (Book 2), Mythic Fiction, Cosmic Horror (hints).</p><p><strong>Target Audience:</strong> Older Young Adult to Adult, interested in complex plots, intricate world-building, Japanese & American folklore, blend of magic/science, and character-driven stories with strong emotional cores.</p>"
                    }
                ]
            },
            "Characters": {
                "Primary Protagonists": [
                    {
                        "title": "Alex 'Bowie' Shepard",
                        "content": "<p>An American expatriate in Tokyo who gets drawn into a supernatural conspiracy after being tasked to find the missing Yume Minamoto. His investigation leads him to develop strange powers and confront ancient forces.</p>"
                    },
                    {
                        "title": "Mizuki / Hisoka",
                        "content": "<p>A half-kitsune investigator searching for her lost mother. She is a powerful ally with a deep connection to the Æther and Japanese folklore.</p>"
                    },
                    {
                        "title": "Carly Shepard",
                        "content": "<p>Bowie's resourceful sister living in the fractured New American Republic (NAR). A skilled scavenger and survivor who becomes a key player in the later stages of the conflict.</p>"
                    },
                    {
                        "title": "Shikako ('Onryō')",
                        "content": "<p>A cybernetically enhanced operative for the Zenko Order. Initially detached and professional, she becomes a crucial member of the team.</p>"
                    },
                    {
                        "title": "Aoi",
                        "content": "<p>A brilliant hacker operating from a fortified bunker in the NAR. Initially motivated by payment, she develops a loyalty to the group after becoming entangled in their conflicts.</p>"
                    },
                    {
                        "title": "Yume Minamoto / Sakura",
                        "content": "<p>The central mystery of Book 1. A sophisticated thought form created by the Mobex Corporation. She is the key to understanding the nature of the Æther and the plans of the Yako Syndicate. She eventually merges with her original essence to become the powerful being known as Sakura.</p>"
                    }
                ],
                "Key Antagonists": [
                    {
                        "title": "Koda",
                        "content": "<p>The true antagonist of the saga. A being who perceives the repeating time loop of reality and seeks to end all existence as an act of mercy. His nihilistic philosophy presents a profound ethical and metaphysical challenge to the heroes.</p>"
                    },
                    {
                        "title": "Commander Colt",
                        "content": "<p>A ruthless Yako Syndicate operative overseeing Project Tsunagari. His ambition and cruelty make him the primary physical threat in Book 1.</p>"
                    }
                ],
                "Minor Characters": [
                    {
                        "title": "Ichiro Kobayashi",
                        "content": "<p>An enigmatic, ancient fortune teller who provides Yume with the special tarot deck, setting the events of the story in motion.</p>"
                    },
                    {
                        "title": "Mr. Whispers",
                        "content": "<p>A talking cat who acts as a cryptic guide for Bowie, providing essential clues and lore about the Æther and kitsune.</p>"
                    },
                    {
                        "title": "Professor Shin'en Tajima",
                        "content": "<p>The brilliant but coerced scientist behind the ARC routers. He ultimately sacrifices himself to thwart Commander Colt's plans.</p>"
                    }
                ]
            },
            "Key Locations": {
                "Main Hubs": [
                    {
                        "title": "Tokyo, Japan",
                        "content": "<p>The primary setting for Book 1. A city of contrasts, where modern skyscrapers hide ancient shrines and corporate conspiracies intersect with supernatural phenomena.</p>"
                    },
                    {
                        "title": "New American Republic (NAR)",
                        "content": "<p>The setting for much of Book 2. A fractured, post-apocalyptic version of the USA characterized by scarcity, local folklore, and hidden dangers.</p>"
                    },
                    {
                        "title": "Ikanajima Island",
                        "content": "<p>A remote island that houses the secret facility for Project Tsunagari and becomes the site of the Book 1 climax.</p>"
                    },
                    {
                        "title": "The Æther",
                        "content": "<p>A liminal dimension that underpins reality. It is a place of immense power, non-linear time, and strange manifestations.</p>"
                    }
                ]
            },
            "Glossary": {
                "Key Terms": [
                    {
                        "title": "Glossary",
                        "content": "<p><strong>Æther:</strong> A liminal, energetic dimension. Source of supernatural power.</p><p><strong>Kitsune:</strong> Magical fox spirits from Japanese folklore.</p><p><strong>Egregore:</strong> A thought form created from collective consciousness.</p><p><strong>The Kirin:</strong> The ultimate Egregore, a conscious, reality-bending weapon.</p><p><strong>Project Tsunagari:</strong> The Yako Syndicate's plan to merge realities.</p><p><strong>Sunyata:</strong> The void of emptiness; Koda's ultimate goal.</p>"
                    }
                ]
            },
            "Themes & Craft": {
                "Core Concepts": [
                     {
                        "title": "Symbolism & Deeper Meanings",
                        "content": "<p><strong>Foxes/Kitsune:</strong> Duality (Zenko vs. Yako), trickery, intelligence, transformation.</p><p><strong>Mirrors:</strong> Self-reflection, truth, illusion, fractured selves, windows to other realities.</p><p><strong>Eyes (especially Green):</strong> Windows to the soul, perception, connection to the Æther. Green eyes (Yume/Sakura) signify an otherworldly nature.</p>"
                    },
                    {
                        "title": "Character Voice & Dialogue Style Guide",
                        "content": "<p><strong>Alex 'Bowie' Shepard:</strong> Informal, prone to mild sarcasm or bewildered humor. Asks questions to make sense of the bizarre.</p><p><strong>Mizuki/Hisoka:</strong> (Mizuki) Guarded, analytical, precise. (Hisoka) More confident, powerful, commanding.</p><p><strong>Carly Shepard:</strong> Pragmatic, direct, no-nonsense from her NAR upbringing.</p>"
                    }
                ]
            }
        };

        // --- GLOBAL STATE ---
        let isEditMode = false;

        // --- DOM ELEMENT REFERENCES ---
        const passwordOverlay = document.getElementById('password-overlay');
        const passwordInput = document.getElementById('password-input');
        const submitPasswordBtn = document.getElementById('submit-password');
        const passwordError = document.getElementById('password-error');
        const mainContent = document.getElementById('main-content');
        const logoutButton = document.getElementById('logout-button');
        const searchInput = document.getElementById('search-input');
        const searchResultsContainer = document.getElementById('search-results-container');
        const addLinkModal = document.getElementById('add-link-modal');
        const cancelLinkButton = document.getElementById('cancel-link-button');
        const insertLinkButton = document.getElementById('insert-link-button');
        const linkTypeSelect = document.getElementById('link-type');
        const viewModeBtn = document.getElementById('view-mode-btn');
        const editModeBtn = document.getElementById('edit-mode-btn');
        const exportButton = document.getElementById('export-button');
        const exportModal = document.getElementById('export-modal');
        const closeExportButton = document.getElementById('close-export-button');
        const copyExportButton = document.getElementById('copy-export-button');
        const bodyEl = document.body;
        
        const PASSWORDS = {
            full: "03311985",
            view: "415semple"
        };
        let currentSelection = null;

        // --- DATA PERSISTENCE ---
        function saveData() {
            try {
                localStorage.setItem('storyBibleData_Aether', JSON.stringify(storyBibleData));
            } catch (e) {
                console.error("Could not save data to localStorage:", e);
            }
        }

        function loadData() {
            const savedData = localStorage.getItem('storyBibleData_Aether');
            if (savedData) {
                try {
                    const localData = JSON.parse(savedData);
                    Object.assign(storyBibleData, localData);
                } catch (e) {
                    console.error("Could not parse saved data:", e);
                }
            }
        }

        // --- AUTHENTICATION ---
        function checkAuth() {
            const accessLevel = sessionStorage.getItem('storyBibleAccessLevel');
            if (accessLevel) {
                passwordOverlay.style.display = 'none';
                mainContent.classList.remove('hidden');
                
                bodyEl.classList.remove('full-access');
                if (accessLevel === 'full') {
                    bodyEl.classList.add('full-access');
                }
                
                loadData();
                setMode(false); 
            } else {
                passwordOverlay.style.display = 'flex';
                mainContent.classList.add('hidden');
            }
        }
        
        function handleLogin() {
            const enteredPassword = passwordInput.value;
            let accessLevel = null;

            if (enteredPassword === PASSWORDS.full) {
                accessLevel = 'full';
            } else if (enteredPassword === PASSWORDS.view) {
                accessLevel = 'view';
            }

            if (accessLevel) {
                sessionStorage.setItem('storyBibleAccessLevel', accessLevel);
                
                passwordOverlay.classList.add('dissolving');
                setTimeout(() => {
                    passwordOverlay.style.opacity = '0';
                    passwordOverlay.addEventListener('transitionend', () => {
                        checkAuth();
                    }, { once: true });
                }, 500);

            } else {
                passwordError.classList.remove('hidden');
                passwordInput.classList.add('border-red-500');
            }
        }

        submitPasswordBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
        
        passwordInput.addEventListener('input', () => {
            passwordError.classList.add('hidden');
            passwordInput.classList.remove('border-red-500');
        });

        logoutButton.addEventListener('click', () => {
            sessionStorage.removeItem('storyBibleAccessLevel');
            localStorage.removeItem('storyBibleData_Aether');
            location.reload();
        });

        // --- VIEW/EDIT MODE LOGIC ---
        function setMode(edit) {
            const accessLevel = sessionStorage.getItem('storyBibleAccessLevel');
            
            if (edit && accessLevel !== 'full') {
                return;
            }

            isEditMode = edit;
            bodyEl.classList.toggle('edit-mode', isEditMode);
            
            if (isEditMode) {
                editModeBtn.classList.add('bg-white', 'text-indigo-600', 'shadow');
                viewModeBtn.classList.remove('bg-white', 'text-indigo-600', 'shadow');
            } else {
                viewModeBtn.classList.add('bg-white', 'text-indigo-600', 'shadow');
                editModeBtn.classList.remove('bg-white', 'text-indigo-600', 'shadow');
            }
            renderApp();
        }
        
        viewModeBtn.addEventListener('click', () => setMode(false));
        editModeBtn.addEventListener('click', () => setMode(true));


        // --- RENDER LOGIC ---
        function renderApp() {
            renderNavigation();
            renderContentSections();
            attachEventListeners();
        }

        function renderNavigation() {
            const navContainer = document.getElementById('navigation-container');
            navContainer.innerHTML = '';
            Object.keys(storyBibleData).forEach(category => {
                const details = document.createElement('details');
                
                const summary = document.createElement('summary');
                summary.className = 'text-sm font-semibold text-gray-500 uppercase tracking-wider mb-1 cursor-pointer';
                summary.textContent = category;
                
                const ul = document.createElement('ul');
                ul.className = 'space-y-1 mb-4 nav-links';
                
                Object.keys(storyBibleData[category]).forEach(sectionKey => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    const sectionId = `${category.replace(/\s+/g, '-')}-${sectionKey.replace(/\s+/g, '-')}`;
                    a.href = `#${sectionId}`;
                    a.textContent = sectionKey;
                    a.className = 'block px-3 py-2 rounded-md text-base font-medium text-gray-600 hover:bg-gray-200 hover:text-gray-900';
                    li.appendChild(a);
                    ul.appendChild(li);
                });

                details.appendChild(summary);
                details.appendChild(ul);
                navContainer.appendChild(details);
            });
        }

        function renderContentSections() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '';
            Object.entries(storyBibleData).forEach(([category, sections]) => {
                Object.entries(sections).forEach(([sectionKey, entries]) => {
                    const section = document.createElement('section');
                    const sectionId = `${category.replace(/\s+/g, '-')}-${sectionKey.replace(/\s+/g, '-')}`;
                    section.id = sectionId;
                    section.className = 'mb-12';

                    const sectionTitle = document.createElement('h2');
                    sectionTitle.className = 'text-3xl font-bold text-gray-900 border-b-2 border-indigo-200 pb-2 mb-6';
                    sectionTitle.textContent = sectionKey;
                    section.appendChild(sectionTitle);

                    const cardContainer = document.createElement('div');
                    cardContainer.className = 'space-y-6';
                    
                    entries.forEach((entry, index) => {
                        cardContainer.appendChild(createCard(category, sectionKey, index, entry));
                    });
                    
                    section.appendChild(cardContainer);

                    const addButton = document.createElement('button');
                    addButton.textContent = `+ Add New Entry to ${sectionKey}`;
                    addButton.className = 'mt-6 bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-600 transition add-entry-btn edit-mode-only';
                    addButton.dataset.category = category;
                    addButton.dataset.section = sectionKey;
                    section.appendChild(addButton);

                    contentArea.appendChild(section);
                });
            });
        }

        function createCard(category, sectionKey, index, entryData) {
            const card = document.createElement('div');
            card.className = 'card p-6';
            card.dataset.category = category;
            card.dataset.section = sectionKey;
            card.dataset.index = index;

            let realWorldHtml = '';
            if (entryData.realWorldEquivalent !== undefined) {
                realWorldHtml = `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <h4 class="text-sm font-semibold text-gray-600 mb-2">Real-World Equivalents & Inspirations</h4>
                        <div class="prose-custom text-sm text-gray-700 editable" contenteditable="${isEditMode}" data-field="realWorldEquivalent">${entryData.realWorldEquivalent}</div>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <h3 class="text-xl font-bold text-gray-800 mb-3 editable" contenteditable="${isEditMode}" data-field="title">${entryData.title}</h3>
                    <button class="add-link-btn text-sm text-indigo-600 hover:text-indigo-800 font-semibold edit-mode-only">Add Links</button>
                </div>
                <div class="prose-custom max-w-none text-gray-700 editable" contenteditable="${isEditMode}" data-field="content">
                    ${entryData.content}
                </div>
                ${realWorldHtml}
            `;
            return card;
        }

        // --- EVENT LISTENERS ---
        function attachEventListeners() {
            const contentArea = document.getElementById('content-area');

            contentArea.addEventListener('blur', (e) => {
                if (isEditMode && e.target.matches('.editable')) {
                    const card = e.target.closest('.card');
                    if (!card) return;
                    const category = card.dataset.category;
                    const section = card.dataset.section;
                    const index = card.dataset.index;
                    const field = e.target.dataset.field;
                    storyBibleData[category][section][index][field] = e.target.innerHTML;
                    saveData();
                }
            }, true);

            contentArea.addEventListener('click', (e) => {
                if (isEditMode && e.target.matches('.add-entry-btn')) {
                    const category = e.target.dataset.category;
                    const section = e.target.dataset.section;
                    const newEntry = { title: "New Title", content: "<p>New content goes here.</p>" };
                    if (storyBibleData[category][section][0]?.realWorldEquivalent !== undefined) {
                        newEntry.realWorldEquivalent = "<p>Real-world equivalent notes.</p>";
                    }
                    storyBibleData[category][section].push(newEntry);
                    saveData();
                    renderApp();
                } else if (isEditMode && e.target.matches('.add-link-btn')) {
                    const editableContent = e.target.closest('.card').querySelector('[data-field="content"]');
                    saveSelection(editableContent);
                    addLinkModal.classList.remove('hidden');
                    document.getElementById('link-text').focus();
                } else if (!isEditMode && e.target.matches('a.internal-link')) {
                    e.preventDefault();
                    const href = e.target.getAttribute('href'); 
                    const searchTerm = decodeURIComponent(href.replace('#/search/', ''));
                    searchInput.value = searchTerm;
                    executeSearchAndDisplay(searchTerm);
                }
            });
        }
        
        // --- EXPORT LOGIC ---
        exportButton.addEventListener('click', () => {
            const finalHtml = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
            document.getElementById('export-textarea').value = finalHtml;
            exportModal.classList.remove('hidden');
        });

        closeExportButton.addEventListener('click', () => {
            exportModal.classList.add('hidden');
        });
        
        copyExportButton.addEventListener('click', () => {
            const textarea = document.getElementById('export-textarea');
            textarea.select();
            document.execCommand('copy');
            copyExportButton.textContent = 'Copied!';
            setTimeout(() => {
                 copyExportButton.textContent = 'Copy to Clipboard';
            }, 2000);
        });

        // --- SEARCH LOGIC ---
        function executeSearchAndDisplay(query) {
            const lowerCaseQuery = query.toLowerCase().trim();
            let firstMatchCard = null;

            const cards = document.querySelectorAll('.card');
            for (const card of cards) {
                const titleEl = card.querySelector('[data-field="title"]');
                if (!titleEl) continue;

                const title = titleEl.textContent.toLowerCase();
                
                if (title === lowerCaseQuery) {
                    firstMatchCard = card;
                    break; 
                }
            }
            
            if (!firstMatchCard && cards.length > 0) {
                 for (const card of cards) {
                    const title = card.querySelector('[data-field="title"]').textContent.toLowerCase();
                    const content = card.querySelector('[data-field="content"]').textContent.toLowerCase();
                    const realWorld = card.querySelector('[data-field="realWorldEquivalent"]')?.textContent.toLowerCase() || '';

                    if (title.includes(lowerCaseQuery) || content.includes(lowerCaseQuery) || realWorld.includes(lowerCaseQuery)) {
                        firstMatchCard = card;
                        break;
                    }
                }
            }

            if (firstMatchCard) {
                clearSearchHighlights();
                firstMatchCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstMatchCard.classList.add('search-highlight');
                highlightTextInNode(firstMatchCard, lowerCaseQuery);

                setTimeout(() => {
                    firstMatchCard.classList.remove('search-highlight');
                }, 2000);
            }
        }
        
        searchInput.addEventListener('input', populateSearchDropdown);
        searchInput.addEventListener('focus', populateSearchDropdown);
        document.addEventListener('click', (e) => {
            if (e.target.id !== 'search-input' && !searchResultsContainer.contains(e.target)) {
                searchResultsContainer.classList.add('hidden');
            }
        });

        function populateSearchDropdown() {
            const query = searchInput.value.toLowerCase().trim();
            searchResultsContainer.innerHTML = '';

            if (query.length < 2) {
                searchResultsContainer.classList.add('hidden');
                clearSearchHighlights();
                return;
            }

            const results = new Set();
            document.querySelectorAll('.card [data-field="title"]').forEach(titleEl => {
                const title = titleEl.textContent;
                if (title.toLowerCase().includes(query)) {
                    results.add(title);
                }
            });

            if (results.size > 0) {
                searchResultsContainer.classList.remove('hidden');
                results.forEach(title => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200';
                    resultDiv.textContent = title;
                    resultDiv.addEventListener('click', () => {
                        searchInput.value = title;
                        executeSearchAndDisplay(title);
                        searchResultsContainer.classList.add('hidden');
                    });
                    searchResultsContainer.appendChild(resultDiv);
                });
            } else {
                searchResultsContainer.classList.add('hidden');
            }
        }
        
        function clearSearchHighlights() {
            document.querySelectorAll('.highlight').forEach(el => {
                if (el.parentNode) {
                    el.outerHTML = el.innerHTML;
                }
            });
        }

        function highlightTextInNode(node, query) {
            clearSearchHighlights();
            const regex = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            const treeWalker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT);
            let textNodes = [];
            while(treeWalker.nextNode()) {
                if (treeWalker.currentNode.parentElement.tagName !== 'SCRIPT' && treeWalker.currentNode.parentElement.tagName !== 'STYLE') {
                    textNodes.push(treeWalker.currentNode);
                }
            }
            
            textNodes.forEach(textNode => {
                const text = textNode.nodeValue;
                if (regex.test(text)) {
                    const fragment = document.createDocumentFragment();
                    let lastIndex = 0;
                    text.replace(regex, (match, ...args) => {
                        const offset = args[args.length - 2];
                        if (offset > lastIndex) {
                            fragment.appendChild(document.createTextNode(text.substring(lastIndex, offset)));
                        }
                        const highlightSpan = document.createElement('span');
                        highlightSpan.className = 'highlight';
                        highlightSpan.textContent = match;
                        fragment.appendChild(highlightSpan);
                        lastIndex = offset + match.length;
                    });
                    if (lastIndex < text.length) {
                        fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                    }
                    if (textNode.parentNode) {
                        textNode.parentNode.replaceChild(fragment, textNode);
                    }
                }
            });
        }

        // --- LINK MODAL LOGIC ---
        linkTypeSelect.addEventListener('change', (e) => {
            const label = document.getElementById('link-target-label');
            const input = document.getElementById('link-target');
            if (e.target.value === 'internal') {
                label.textContent = 'Reference (Entry Name)';
                input.placeholder = 'e.g., Alex \'Bowie\' Shepard';
            } else {
                label.textContent = 'URL';
                input.placeholder = 'https://en.wikipedia.org/wiki/...';
            }
        });

        cancelLinkButton.addEventListener('click', () => {
            addLinkModal.classList.add('hidden');
            currentSelection = null;
        });

        insertLinkButton.addEventListener('click', () => {
            const linkText = document.getElementById('link-text').value;
            const linkType = document.getElementById('link-type').value;
            const linkTarget = document.getElementById('link-target').value;

            if (!linkText || !linkTarget) {
                alert('Please fill in both Link Text and the target/URL.');
                return;
            }

            let linkHtml;
            if (linkType === 'internal') {
                linkHtml = `<a href="#/search/${encodeURIComponent(linkTarget)}" class="internal-link">${linkText}</a>`;
            } else {
                linkHtml = `<a href="${linkTarget}" class="external-link" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
            }

            restoreSelection();
            if (window.getSelection().rangeCount > 0) {
                 document.execCommand('insertHTML', false, linkHtml + '&nbsp;');
            }

            if (currentSelection && currentSelection.focusNode) {
                const editable = currentSelection.focusNode.parentElement.closest('.editable');
                if (editable) {
                    editable.dispatchEvent(new Event('blur', { bubbles: true }));
                }
            }

            document.getElementById('link-text').value = '';
            document.getElementById('link-target').value = '';
            addLinkModal.classList.add('hidden');
            currentSelection = null;
        });

        function saveSelection(containerEl) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && containerEl.contains(selection.getRangeAt(0).commonAncestorContainer)) {
                currentSelection = selection.getRangeAt(0).cloneRange();
                document.getElementById('link-text').value = currentSelection.toString();
            } else {
                currentSelection = null;
                document.getElementById('link-text').value = '';
            }
        }

        function restoreSelection() {
            if (currentSelection) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(currentSelection);
            }
        }

        // --- INITIALIZATION ---
        checkAuth();
    });
    </script>

</body>
</html>
