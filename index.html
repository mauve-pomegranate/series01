<script id="app-logic">
    document.addEventListener('DOMContentLoaded', () => {
        const storyBibleData = {
            "Series Overview": overviewData,
            "Characters": charactersData,
            "Book Synopsis": synopsisData,
            "Timeline": timelineData,
            "Key Locations": locationsData,
            "Factions": factionsData,
            "Cosmology & Dimensions": cosmologyData,
            "Supernatural Beings & Entities": beingsData,
            "Flora & Fauna": { "Flora": floraData, "Fauna": faunaData },
            "Environmental Phenomena": phenomenaData,
            "Magic, Metaphysics & Fringe Science": magicData,
            "Key Artifacts & Technology": artifactsData,
            "Themes": themesData,
            "Writing Craft": writingCraftData,
            "Glossary": glossaryData,
            "Critical Questions": plotholesData
        };

        // Fix for duplicate navigation entries by making Timeline keys unique
        for (const key in storyBibleData["Timeline"]) {
            const newKey = `Timeline for ${key}`;
            if (!storyBibleData["Timeline"].hasOwnProperty(newKey)) {
                storyBibleData["Timeline"][newKey] = storyBibleData["Timeline"][key];
                delete storyBibleData["Timeline"][key];
            }
        }

        const searchIndex = [];
        const passwordOverlay = document.getElementById('password-overlay');
        const passwordInput = document.getElementById('password-input');
        const submitPasswordBtn = document.getElementById('submit-password');
        const mainContent = document.getElementById('main-content');
        const searchInput = document.getElementById('search-input');
        const backToTopButton = document.getElementById('back-to-top');
        const navContainer = document.getElementById('navigation-container');
        const contentArea = document.getElementById('content-area');
        const logoutButton = document.getElementById('logout-button');
        const errorMessage = document.getElementById('error-message');
        const zoomMessage = document.getElementById('zoom-message');
        const logoutOverlay = document.getElementById('logout-overlay');
        const logoutMessage = document.getElementById('logout-message');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileNav = document.getElementById('mobile-nav');
        const navOverlay = document.getElementById('nav-overlay');

        const LOGIN_MESSAGES = ["ト ゥ  ル   パ", "プロジェクトさくら", "怨霊を展開する"];
        const LOGOUT_MESSAGES = ["CONVERGENCE IMMINENT", "LOOK FOR THE GREEN EYES", "ÆTHERIC DISTURBANCES DETECTED"];
        
        const PASSWORDS = { full: "03311985", view: "415semple" };
        
        // --- YouTube Player Logic ---
        let player;
        let stopTimer;
        window.onYouTubeIframeAPIReady = function() {
            player = new YT.Player('player', {
                height: '0',
                width: '0',
                videoId: 'sA_D3sJ25sg', // Video ID for the new music
                playerVars: {
                    'playsinline': 1,
                    'autoplay': 0,
                    'controls': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            // Player is ready
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                clearTimeout(stopTimer);
                stopTimer = setTimeout(() => {
                    player.stopVideo();
                }, 15000); 
            }
        }
        
        function playLoginSound() {
            if (player && typeof player.playVideo === 'function') {
                player.playVideo();
            }
        }
        // --- End YouTube Player Logic ---

        function checkAuth() {
            if (sessionStorage.getItem('storyBibleAccessLevel')) {
                mainContent.classList.remove('hidden');
                passwordOverlay.style.display = 'none';
                buildSearchIndex();
                renderApp();
            } else {
                passwordOverlay.style.display = 'flex';
                mainContent.classList.add('hidden');
            }
        }
        
        function handleLogin() {
            errorMessage.classList.add('hidden'); 
            if (passwordInput.value === PASSWORDS.full || passwordInput.value === PASSWORDS.view) {
                playLoginSound(); 
                sessionStorage.setItem('storyBibleAccessLevel', 'view');
                zoomMessage.textContent = LOGIN_MESSAGES[Math.floor(Math.random() * LOGIN_MESSAGES.length)];
                passwordOverlay.classList.add('rainbow-bg');
                passwordOverlay.querySelector('div').style.display = 'none'; 
                setTimeout(() => {
                    zoomMessage.style.transform = 'scale(1)';
                }, 100);
                setTimeout(() => {
                    passwordOverlay.classList.add('fade-out');
                    setTimeout(() => {
                        checkAuth();
                    }, 500);
                }, 2000); 
            } else {
                errorMessage.textContent = "This is not for you";
                errorMessage.classList.remove('hidden');
                passwordInput.value = "";
            }
        }

        function handleLogout() {
            logoutMessage.textContent = LOGOUT_MESSAGES[Math.floor(Math.random() * LOGOUT_MESSAGES.length)];
            logoutOverlay.style.display = 'flex';
            setTimeout(() => {
                logoutOverlay.style.opacity = '1';
            }, 10);
            setTimeout(() => {
                sessionStorage.removeItem('storyBibleAccessLevel');
                window.location.reload();
            }, 2000);
        }

        function renderApp() {
            renderNavigation(navContainer); 
            renderNavigation(mobileNav); 
            renderContentSections();
        }

        function renderNavigation(container) {
            container.innerHTML = '';
            Object.entries(storyBibleData).forEach(([category, sections]) => {
                const categoryDetails = document.createElement('details');
                if (container.id === 'navigation-container' && category !== "Timeline" && Object.keys(storyBibleData)[0] === category) {
                    categoryDetails.open = true;
                }

                const categorySummary = document.createElement('summary');
                categorySummary.className = 'text-lg font-bold text-gray-700 mb-2';
                categorySummary.textContent = category;
                categoryDetails.appendChild(categorySummary);

                const sectionsList = document.createElement('ul');
                sectionsList.className = 'nav-links-flat space-y-1';

                Object.entries(sections).forEach(([sectionKey, sectionData]) => {
                    if (sectionData && Array.isArray(sectionData.items)) {
                        const isRedundantSection = sectionData.items.length === 1 && sectionData.items[0].title === sectionKey;
                        if(isRedundantSection) {
                            const entry = sectionData.items[0];
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = `#${generateId(entry.title)}`;
                            a.textContent = entry.title;
                            a.className = 'block px-3 py-1 text-sm text-gray-600 hover:bg-gray-200 rounded-md';
                            li.appendChild(a);
                            sectionsList.appendChild(li);
                        } else {
                            const li = document.createElement('li');
                            const sectionDetails = document.createElement('details');
                            const sectionSummary = document.createElement('summary');
                            sectionSummary.className = 'text-sm font-semibold text-gray-500 uppercase';
                            sectionSummary.textContent = sectionKey;
                            const ul = document.createElement('ul');
                            ul.className = 'nav-links space-y-1 mt-1';
                            sectionData.items.forEach(entry => {
                                const subLi = document.createElement('li');
                                const a = document.createElement('a');
                                a.href = `#${generateId(entry.title)}`;
                                a.textContent = entry.title;
                                a.className = 'block px-3 py-1 text-sm text-gray-600 hover:bg-gray-200 rounded-md';
                                subLi.appendChild(a);
                                ul.appendChild(subLi);
                            });
                            sectionDetails.appendChild(sectionSummary);
                            sectionDetails.appendChild(ul);
                            li.appendChild(sectionDetails);
                            sectionsList.appendChild(li);
                        }
                    }
                });
                categoryDetails.appendChild(sectionsList);
                container.appendChild(categoryDetails);
            });
        }

        function renderContentSections() {
            contentArea.innerHTML = '';
            Object.entries(storyBibleData).forEach(([category, sections]) => {
                if (category === "Timeline") {
                    const timelineSection = document.createElement('section');
                    timelineSection.id = generateId(category);
                    contentArea.appendChild(timelineSection);
                    renderTimeline(timelineSection, sections);
                    return;
                }

                Object.entries(sections).forEach(([sectionKey, sectionData]) => {
                     if (sectionData && Array.isArray(sectionData.items)) {
                        const sectionElement = document.createElement('section');
                        sectionElement.id = generateId(sectionKey);
                        const isRedundantTitle = sectionData.items.length === 1 && sectionData.items[0].title === sectionKey;
                        if (!isRedundantTitle) {
                            sectionElement.className = 'mb-12';
                            const sectionTitle = document.createElement('h2');
                            sectionTitle.className = 'text-3xl font-bold text-gray-900 border-b-2 border-indigo-200 pb-2 mb-6';
                            sectionTitle.textContent = sectionKey;
                            sectionElement.appendChild(sectionTitle);
                        }
                        const cardContainer = document.createElement('div');
                        cardContainer.className = isRedundantTitle ? 'space-y-0' : 'space-y-6';
                        sectionData.items.forEach(entry => cardContainer.appendChild(createCard(entry)));
                        sectionElement.appendChild(cardContainer);
                        contentArea.appendChild(sectionElement);
                    }
                });
            });
        }

        function renderTimeline(container, timelineData) {
            Object.entries(timelineData).forEach(([bookTitle, bookData]) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'timeline-wrapper';
                const titleElement = document.createElement('div');
                titleElement.className = 'text-center mb-12';
                // Display the original book title without the "Timeline for" prefix
                const displayTitle = bookTitle.startsWith("Timeline for ") ? bookTitle.substring(13) : bookTitle;
                titleElement.innerHTML = `<h2 class="text-3xl font-bold text-gray-900">${displayTitle}</h2>`;
                wrapper.appendChild(titleElement);
                const timelineContainer = document.createElement('div');
                timelineContainer.className = 'timeline-container';
                bookData.items.forEach((event, index) => {
                    const item = document.createElement('div');
                    const side = index % 2 === 0 ? 'left' : 'right';
                    item.className = `timeline-item ${side}`;
                    item.dataset.eventNum = event.event_num;
                    item.innerHTML = `
                        <div class="timeline-content">
                            <h3 class="text-xl font-bold">${event.title}</h3>
                            <div class="prose-custom mt-2">${event.description}</div>
                        </div>
                    `;
                    timelineContainer.appendChild(item);
                });
                wrapper.appendChild(timelineContainer);
                container.appendChild(wrapper);
            });
        }
        
        function createCard(entryData) {
            const card = document.createElement('div');
            card.id = generateId(entryData.title);
            card.className = 'card p-6';
            const realWorldHtml = entryData.realWorldEquivalent ? `<div class="mt-4 pt-4 border-t"><h4 class="text-sm font-semibold">Inspirations</h4><div class="prose-custom">${entryData.realWorldEquivalent}</div></div>` : '';
            card.innerHTML = `<h3 class="text-xl font-bold mb-3">${entryData.title}</h3><div class="prose-custom">${entryData.content || ''}</div>${realWorldHtml}`;
            return card;
        }

        function buildSearchIndex() {
            searchIndex.length = 0;
            Object.values(storyBibleData).forEach(categoryData => {
                if(categoryData) {
                    Object.values(categoryData).forEach(sectionData => {
                        if (sectionData && Array.isArray(sectionData.items)) {
                            sectionData.items.forEach(item => {
                                if (item && item.title) {
                                    searchIndex.push({ title: item.title, id: generateId(item.title) });
                                }
                            });
                        }
                    });
                }
            });
        }
        
        function executeSearch(query) {
             const lowerCaseQuery = query.toLowerCase().trim();
             const result = searchIndex.find(item => item.title.toLowerCase().trim() === lowerCaseQuery);
             if (result) {
                const targetCard = document.getElementById(result.id);
                if(targetCard) {
                    targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    targetCard.classList.add('search-highlight');
                    setTimeout(() => targetCard.classList.remove('search-highlight'), 2000);
                }
             }
        }
        
        function generateId(text) { return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, ''); }

        // Mobile Menu Logic
        function toggleMobileMenu() {
            const isOpen = mobileNav.classList.contains('open');
            mobileNav.classList.toggle('open');
            navOverlay.classList.toggle('hidden', isOpen);
        }
        mobileMenuButton.addEventListener('click', toggleMobileMenu);
        navOverlay.addEventListener('click', toggleMobileMenu);

        submitPasswordBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', e => e.key === 'Enter' && handleLogin());
        logoutButton.addEventListener('click', handleLogout);
        window.addEventListener('scroll', () => { backToTopButton.classList.toggle('visible', window.scrollY > 300); });
        searchInput.addEventListener('input', () => executeSearch(searchInput.value));
        
        function handleHashChange() {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#/search/')) {
                const query = decodeURIComponent(hash.substring(9));
                executeSearch(query);
                if (window.innerWidth < 1024 && mobileNav.classList.contains('open')) { 
                    toggleMobileMenu();
                }
            }
        }
        window.addEventListener('hashchange', handleHashChange);
        
        checkAuth();
        handleHashChange();

    });
    </script>
